<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
</head>
<body>

    <script>
    var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 600 },
                debug: true
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    var game = new Phaser.Game(config);

    var square;
    var spaceKey;
    var leftKey;
    var rightKey;
    var holdStart = 0;
    var maxHold = 1000;
    var isCharging = false;
    var onGround = false;
    var jumpDirection = 1;
    var platform;

    function preload ()
    {
        this.load.image('sky', 'assets/backgrounds/space3.png');
        this.load.image('red', 'assets/particles/red.png');
    }

    function create ()
    {
        this.add.image(400, 300, 'sky');

        var particles = this.add.particles('red');

        var emitter = particles.createEmitter({
            speed: 75,
            scale: { start: 1, end: 0 },
            blendMode: 'ADD'
        });

        var squareGraphics = this.add.graphics();
        squareGraphics.fillStyle(0xff0000, 1);
        squareGraphics.fillRect(0, 0, 70, 70);

        squareGraphics.generateTexture('square', 70, 70);

        squareGraphics.destroy();

        square = this.physics.add.image(400, 100, 'square');
        square.setCollideWorldBounds(true);
        square.setImmovable(false);
        square.body.setAllowGravity(true);
        square.body.setVelocity(0, 0);

        platform = this.physics.add.staticImage(400, 400, null);
        platform.displayWidth = 200;
        platform.displayHeight = 30;
        platform.setOrigin(0.5, 0.5);

        platform.body.setSize(platform.displayWidth, platform.displayHeight);
        platform.body.setOffset(-platform.displayWidth / 2 + 15, 0);

        var platformGraphics = this.add.graphics();
        platformGraphics.fillStyle(0x00ff00, 1);
        platformGraphics.fillRect(platform.x - platform.displayWidth / 2, platform.y - platform.displayHeight / 2, platform.displayWidth, platform.displayHeight);

        this.physics.add.collider(square, platform, function (squareObj, platformObj) {
            if (squareObj.body.touching.down && platformObj.body.touching.up) {
                square.setVelocity(0, 0);
                onGround = true;
            }
        });

        emitter.startFollow(square);

        spaceKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
        leftKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT);
        rightKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT);
    }

    function update ()
    {
        if (isCharging) {
            if (leftKey.isDown) {
                jumpDirection = -1;
            } else if (rightKey.isDown) {
                jumpDirection = 1;
            }
        }

        if (spaceKey.isDown && !isCharging && onGround) {
            holdStart = this.time.now;
            isCharging = true;
            console.log("Charging...");
        }

        if (square.y + square.height / 2 >= this.physics.world.bounds.bottom) {
            onGround = true;
        }

        if (onGround) {
            square.setVelocity(0, 0);
        }

        if (isCharging && spaceKey.isUp) {
            var holdTime = Phaser.Math.Clamp(this.time.now - holdStart, 0, maxHold);
            var force = Phaser.Math.Linear(300, 800, holdTime / maxHold);
            square.setVelocity(jumpDirection * force, -force);
            onGround = false;
            isCharging = false;
        }
    }
    </script>
</body>
</html>