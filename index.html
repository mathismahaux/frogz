<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
</head>
<body>

    <script>
    var WORLD_WIDTH = 1950;

    var config = {
        type: Phaser.AUTO,
        width: window.innerWidth,
        height: 600,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 600 },
                debug: true
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    var game = new Phaser.Game(config);

    var square;
    var spaceKey;
    var leftKey;
    var rightKey;
    var holdStart = 0;
    var maxHold = 500;
    var isCharging = false;
    var onGround = false;
    var jumpDirection = 1;
    var platform;

    function preload ()
    {
        this.load.image('sky', 'assets/backgrounds/space3.png');
        this.load.image('red', 'assets/particles/red.png');
    }

    function create ()
    {
//        this.add.tileSprite(0, 0, this.sys.game.config.width, this.sys.game.config.height, 'sky').setOrigin(0, 0);
        this.add.tileSprite(0, 0, WORLD_WIDTH, this.sys.game.config.height, 'sky').setOrigin(0, 0);
        this.cameras.main.setBounds(0, 0, WORLD_WIDTH, this.sys.game.config.height);
        this.physics.world.setBounds(0, 0, WORLD_WIDTH, this.sys.game.config.height);

        var particles = this.add.particles('red');

        var emitter = particles.createEmitter({
            speed: 75,
            scale: { start: 1, end: 0 },
            blendMode: 'ADD'
        });

        var squareGraphics = this.add.graphics();
        squareGraphics.fillStyle(0xff0000, 1);
        squareGraphics.fillRect(0, 0, 70, 70);

        squareGraphics.generateTexture('square', 70, 70);

        squareGraphics.destroy();

        square = this.physics.add.image(400, 100, 'square');
        square.setCollideWorldBounds(true);
        square.setImmovable(false);
        square.body.setAllowGravity(true);
        square.body.setVelocity(0, 0);

        platform = makePlatform(this, 325, 400, 200, 30);
        platform = makePlatform(this, 975, 400, 200, 30);
        platform = makePlatform(this, 1550, 400, 200, 30);

        emitter.startFollow(square);

        this.cameras.main.startFollow(square, true, 0.1, 0.1);

        spaceKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
        leftKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT);
        rightKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT);
    }

    function makePlatform(scene, x, y, displayWidth, displayHeight) {
        displayWidth = displayWidth || 200;
        displayHeight = displayHeight || 30;

        var p = scene.physics.add.staticImage(x, y, null);
        p.displayWidth = displayWidth;
        p.displayHeight = displayHeight;
        p.setOrigin(0.5, 0.5);

        p.body.setSize(p.displayWidth, p.displayHeight);
        p.body.setOffset(-p.displayWidth / 2 + 15, 0);

        var g = scene.add.graphics();
        g.fillStyle(0x00ff00, 1);
        g.fillRect(p.x - p.displayWidth / 2, p.y - p.displayHeight / 2, p.displayWidth, p.displayHeight);

        scene.physics.add.collider(square, p, function (squareObj, platformObj) {
            if (squareObj.body.touching.down && platformObj.body.touching.up) {
                square.setVelocity(0, 0);
                onGround = true;
            }
        });

        return p;
    }

    function update ()
    {
        if (isCharging) {
            if (leftKey.isDown) {
                jumpDirection = -1;
            } else if (rightKey.isDown) {
                jumpDirection = 1;
            }
        }

        if (spaceKey.isDown && !isCharging && onGround) {
            holdStart = this.time.now;
            isCharging = true;
            console.log("Charging...");
        }

        if (square.y + square.height / 2 >= this.physics.world.bounds.bottom) {
            onGround = true;
        }

        if (onGround) {
            square.setVelocity(0, 0);
        }

        if (isCharging && spaceKey.isUp) {
            var holdTime = Phaser.Math.Clamp(this.time.now - holdStart, 0, maxHold);
            var force = Phaser.Math.Linear(100, 600, holdTime / maxHold);
            square.setVelocity(jumpDirection * force, -force);
            onGround = false;
            isCharging = false;
        }
    }
    </script>
</body>
</html>